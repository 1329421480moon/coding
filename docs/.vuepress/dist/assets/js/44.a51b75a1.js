(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{280:function(t,e,s){"use strict";s.r(e);var a=s(0),n=Object(a.a)({},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"数据库操作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据库操作","aria-hidden":"true"}},[t._v("#")]),t._v(" 数据库操作")]),t._v(" "),s("p",[t._v("PHP操作数据库的方式有多种如 "),s("code",[t._v("mysql")]),t._v(" 、"),s("code",[t._v("mysqli")]),t._v("、"),s("code",[t._v("PDO")]),t._v("，目前主要使用的是PDO处理。")]),t._v(" "),s("p",[t._v("PDO 提供了一个数据访问抽象层，这意味着，不管使用哪种数据库，都可以用相同的函数（方法）来查询和获取数据。")]),t._v(" "),s("h2",{attrs:{id:"连接数据库"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#连接数据库","aria-hidden":"true"}},[t._v("#")]),t._v(" 连接数据库")]),t._v(" "),s("p",[t._v("下面是使用 "),s("code",[t._v("PDO")]),t._v(" 连接数据库的操作，当连接失败时将抛出异常。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("<?php\nheader('Content-type:text/html;charset=utf8');\n$config = [\n    'host' => 'localhost',\n    'user' => 'root',\n    'password' => '',\n    'db' => 'houdunren',\n    'charset'=>'utf8'\n];\ntry {\n    $dsn = sprintf('mysql:host=%s;dbname=%s;charset=utf8', $config['host'], $config['db'],$config['charset']);\n    $pdo =  new PDO($dsn, $config['user'], $config['password']);\n} catch (PDOException $e) {\n    die($e->getMessage());\n}\n\n")])])]),s("h2",{attrs:{id:"错误处理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#错误处理","aria-hidden":"true"}},[t._v("#")]),t._v(" 错误处理")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("错误类型")]),t._v(" "),s("th",[t._v("说明")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("PDO::ERRMODE_SILENT")]),t._v(" "),s("td",[t._v("不显示错误")])]),t._v(" "),s("tr",[s("td",[t._v("PDO::ERRMODE_WARNING")]),t._v(" "),s("td",[t._v("显示警告错误")])]),t._v(" "),s("tr",[s("td",[t._v("PDO::ERRMODE_EXCEPTION")]),t._v(" "),s("td",[t._v("抛出异常")])])])]),t._v(" "),s("p",[t._v("可以在连接时设置错误类型")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$pdo =  new PDO($dns, $config['user'], $config['password'], [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]);\n")])])]),s("p",[t._v("也可以使用 "),s("code",[t._v("setAttribute")]),t._v(" 方法设置错误处理方式")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("...\n$pdo =  new PDO($dns, $config['user'], $config['password']);\n$pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_WARNING);\n...\n")])])]),s("h2",{attrs:{id:"执行语句"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#执行语句","aria-hidden":"true"}},[t._v("#")]),t._v(" 执行语句")]),t._v(" "),s("p",[t._v("使用 "),s("code",[t._v("exec")]),t._v(" 方法可以发送执行语言")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('$pdo->exec("INSERT INTO news (title) VALUES(\'houdunren.com\')");\necho "自增主键:".$pdo->lastInsertId();\n')])])]),s("p",[t._v("执行删除操作")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('$affectedRows = $pdo->exec("DELETE FROM news WHERE id>3");\necho "受影响的条数：".$affectedRows;\n')])])]),s("h2",{attrs:{id:"发送查询"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#发送查询","aria-hidden":"true"}},[t._v("#")]),t._v(" 发送查询")]),t._v(" "),s("p",[s("strong",[t._v("设置返回列名")])]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("属性")]),t._v(" "),s("th",[t._v("说明")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[s("em",[t._v("PDO::CASE_LOWER")])]),t._v(" "),s("td",[t._v("强制列名小写")])]),t._v(" "),s("tr",[s("td",[s("em",[t._v("PDO::CASE_NATURAL")])]),t._v(" "),s("td",[t._v("保留数据库驱动返回的列名")])]),t._v(" "),s("tr",[s("td",[s("em",[t._v("PDO::CASE_UPPER")])]),t._v(" "),s("td",[t._v("强制列名大写")])])])]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$pdo->setAttribute(PDO::ATTR_CASE,PDO::CASE_LOWER);\n")])])]),s("p",[s("strong",[t._v("返回结果")])]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("返回类型")]),t._v(" "),s("th",[t._v("说明")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("$result->fetchAll(PDO::FETCH_ASSOC)")]),t._v(" "),s("td",[t._v("获得关联数据")])]),t._v(" "),s("tr",[s("td",[t._v("$result->fetchAll(PDO::FETCH_NUM)")]),t._v(" "),s("td",[t._v("获得索引数据")])]),t._v(" "),s("tr",[s("td",[t._v("$result->fetchAll(PDO::FETCH_BOTH)")]),t._v(" "),s("td",[t._v("同时获取关联与索引数据")])]),t._v(" "),s("tr",[s("td",[t._v("$result->fetchAll(PDO::FETCH_OBJ)")]),t._v(" "),s("td",[t._v("获取对象类型数据")])])])]),t._v(" "),s("h3",{attrs:{id:"fetchall"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#fetchall","aria-hidden":"true"}},[t._v("#")]),t._v(" fetchAll")]),t._v(" "),s("p",[t._v("一次获取所有结果")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('...\n$query = $pdo->query("select * from news");\n$rows = $query->fetchAll();\nprint_r($rows);\n...\n')])])]),s("h3",{attrs:{id:"fetch"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#fetch","aria-hidden":"true"}},[t._v("#")]),t._v(" fetch")]),t._v(" "),s("p",[t._v("每次获取结果中的一条数据")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("...\n$pdo =  new PDO($dns, $config['user'], $config['password']);\n$query = $pdo->query(\"select * from news\");\nwhile ($field = $query->fetch(PDO::FETCH_ASSOC)) {\n\techo sprintf(\"编号:%s\\t标题:%s<br/>\", $field['id'], $field['title']);\n}\n...\n")])])]),s("h2",{attrs:{id:"预准备"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#预准备","aria-hidden":"true"}},[t._v("#")]),t._v(" 预准备")]),t._v(" "),s("p",[t._v("预准备是将SQL的解析阶段与参数绑定分开执行，从而可以有效的防止SQL注入。")]),t._v(" "),s("h3",{attrs:{id:"sql注入"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#sql注入","aria-hidden":"true"}},[t._v("#")]),t._v(" SQL注入")]),t._v(" "),s("p",[t._v("下面来看一个SQL注入的例子")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$query = $pdo->query(\"SELECT * FROM news WHERE id={$_GET['id']}\");\n")])])]),s("p",[t._v("如果GET参数如下将产生SQL注入")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("http://houdunren.test/1.php?id=1 or id>1\n")])])]),s("h3",{attrs:{id:"使用预准备"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用预准备","aria-hidden":"true"}},[t._v("#")]),t._v(" 使用预准备")]),t._v(" "),s("p",[t._v("因为预准备是将解析与参数分开处理，可以有效的防止SQL注入。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$sql = \"SELECT * FROM news WHERE id=:id\";\n$sth = $pdo->prepare($sql);\n$sth->execute([':id' => $_GET['id']]);\n$rows = $sth->fetchAll(PDO::FETCH_ASSOC);\nprint_r($rows);\n")])])]),s("p",[s("strong",[t._v("预准备添加记录")])]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$sql = \"INSERT INTO news (title) VALUES(?)\";\n$sth = $pdo->prepare($sql);\n$sth->execute(['houdunren.com']);\necho $pdo->lastInsertId();\n")])])]),s("p",[s("strong",[t._v("使用点位符操作")])]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('$sth = $pdo->prepare("SELECT * FROM news WHERE id>?");\n$sth->execute([3]);\nprint_r($sth->fetchAll());\n')])])]),s("h2",{attrs:{id:"sql生成器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#sql生成器","aria-hidden":"true"}},[t._v("#")]),t._v(" SQL生成器")]),t._v(" "),s("h3",{attrs:{id:"处理类"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#处理类","aria-hidden":"true"}},[t._v("#")]),t._v(" 处理类")]),t._v(" "),s("p",[t._v("下面构建一个SQL语句生成器，用于快速操作数据库。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("<?php\n\nnamespace Database;\n\nuse PDO;\nuse Exception;\n\nclass DB\n{\n    protected $link = null;\n    protected $options = ['table' => '', 'field' => '', 'limit' => '', 'order' => '', 'where' => ''];\n    public function __construct($config)\n    {\n        $this->connect($config);\n    }\n    public function connect($config)\n    {\n        if (is_null($this->link)) {\n            $dsn = sprintf('mysql:host=%s;dbname=%s;charset=utf8', $config['host'], $config['db']);\n            $this->link =  new PDO($dsn, $config['user'], $config['password'], [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]);\n        }\n        return $this->link;\n    }\n    public function query($sql, array $vars = [])\n    {\n        $sth = $this->link->prepare($sql);\n        $sth->execute($vars);\n        return $sth->fetchAll();\n    }\n    public function execute($sql, array $vars = [])\n    {\n        $sth = $this->link->prepare($sql);\n        return $sth->execute($vars);\n    }\n    public function field(...$fields)\n    {\n        $this->options['field'] = '`' . implode('`,`', $fields) . '`';\n        return $this;\n    }\n    public function table(string $table)\n    {\n        $this->options['table'] = $table;\n        return $this;\n    }\n    public function get()\n    {\n        $sql  = \"SELECT {$this->options['field']} FROM {$this->options['table']} {$this->options['where']} {$this->options['order']} {$this->options['limit']}\";\n        return $this->link->query($sql);\n    }\n    public function orderBy(string $order)\n    {\n        $this->options['order'] = \" ORDER BY \" . $order;\n        return $this;\n    }\n    public function limit(...$limit)\n    {\n        $this->options['limit'] = \" LIMIT \" . implode(',', $limit);\n        return $this;\n    }\n    public function where(string $where)\n    {\n        $this->options['where'] = \" WHERE \" . $where;\n        return $this;\n    }\n    public function insert(array $vars)\n    {\n        $sql = \"INSERT INTO {$this->options['table']} (\" . implode(',', array_keys($vars)) . \") VALUES(\" . implode(',', array_fill(0, count($vars), '?')) . \")\";\n        return $this->execute($sql, array_values($vars));\n    }\n    public function delete()\n    {\n        $sql = \"DELETE FROM {$this->options['table']} {$this->options['where']}\";\n        return $this->execute($sql);\n    }\n    public function update(array $vars)\n    {\n        if (empty($this->options['where']))\n            throw new Exception('不能缺少条件');\n        $sql  = \"UPDATE {$this->options['table']} SET \" . implode('=?,', array_keys($vars)) . \"=? {$this->options['where']}\";\n        return $this->execute($sql, array_values($vars));\n    }\n}\n")])])]),s("h3",{attrs:{id:"预准备查询"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#预准备查询","aria-hidden":"true"}},[t._v("#")]),t._v(" 预准备查询")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("...\n$db->query(\"SELECT * FROM news WHERE id>=:id\", ['id' => 1])\n...\n")])])]),s("h3",{attrs:{id:"预准备执行"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#预准备执行","aria-hidden":"true"}},[t._v("#")]),t._v(" 预准备执行")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$db->execute(\"INSERT INTO news (title) VALUES(?)\", ['hdcms.com'])\n")])])]),s("h3",{attrs:{id:"对象实例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#对象实例","aria-hidden":"true"}},[t._v("#")]),t._v(" 对象实例")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("use Database\\DB;\ninclude 'DB.php';\n$config = [\n    'host' => 'localhost',\n    'user' => 'root',\n    'password' => '',\n    'db' => 'houdunren'\n];\n\ntry {\n\t...\n    $db = new DB($config);\n    ...\n}catch(Exception $e){\n\tdie($e->getMessage());\n}\n")])])]),s("h3",{attrs:{id:"查询操作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查询操作","aria-hidden":"true"}},[t._v("#")]),t._v(" 查询操作")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("...\n$rows = $db->table('news')->field('id', 'title')->limit(1, 3)->orderBy('id desc')->where(\"id>3\")->get();\n...\n")])])]),s("h3",{attrs:{id:"新增操作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#新增操作","aria-hidden":"true"}},[t._v("#")]),t._v(" 新增操作")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("...\n$db->prepareExecute(\"INSERT INTO news (title) VALUES(?)\", ['hdcms.com']);\n...\n")])])]),s("h3",{attrs:{id:"更新操作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#更新操作","aria-hidden":"true"}},[t._v("#")]),t._v(" 更新操作")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("...\n$db->table('news')->where('id=1')->update(['title' => \"sina\", 'author' => '后盾人', 'description' => '个性介绍']);\n...\n")])])]),s("h3",{attrs:{id:"删除操作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#删除操作","aria-hidden":"true"}},[t._v("#")]),t._v(" 删除操作")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("...\n$db->table('news')->where('id>2')->delete();\n...\n")])])])])},[],!1,null,null,null);e.default=n.exports}}]);