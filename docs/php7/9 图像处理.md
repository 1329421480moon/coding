# 图像处理

## 配置环境

PHP中图像处理需要GD库的支持。

在windows系统中修改php.ini文件，删除 extension=php_gd2.dll 前面的`;`开启图像处理支持。

centos中使用 `yum install php-gd*` 

ubuntu系统中使用 `apt-get install php7.3-gd`

**检测GD库是否加载**

```
$has = extension_loaded('GD');
var_dump($has);
```

## 使用方法

PHP创建图像步骤

1. 发送HTTP头信息，声明内容为图像
2. 创建画布
3. 创建绘图所需要的颜色
4. 绘图（填充画布、画圆、画方块、画线条、画布上写字）
5. 输出图像
6. 释放画布资源

### 头信息

通过header() 函数告诉浏览器，输出的是一个图像而不是文本或HTML，这样浏览器就可以正常显示图像了。

* header('Content-type:image/gif');
* header('Content-type:image/jpeg');
* header('Content-type:image/png');

```
header('Content-type:image/jpeg');
readfile('user.jpeg');
```

### 创建画布

imageCreateTrueColor(width,height)

- 传入的两个参数分别为画布的宽和高，在绘图时超出宽高的部分将不予显示，且此尺寸即为生成图片文件时的尺寸。
-  返回值为资源类型。

### 设置颜色

imageColorAllocate(img_resource,R,G,B)

- 颜色从属于某个图像资源而存在。
- 颜色实际上是一个整形数值。
- 颜色的后三个参数需传入值的范围是0~255

### 填充颜色

imageFill(img_resource,x,y,color)

- (x,y)表示从哪个点开始填充颜色的坐标
- 不填充画布的话，默认是黑色

```
header('Content-type:image/jpeg');
$res = imagecreatetruecolor(1000, 500);
$red = imagecolorallocate($res, 255, 0, 0);
imagefill($res, 0, 0, $red);
imagejpeg($res);
```

### 绘制矩形

**绘制空心矩形**

- imageRectangle(img_res,x1,y1,x2,y2,color)

```
header('Content-type:image/jpeg');
$res = imagecreatetruecolor(1000, 500);
$red = imagecolorallocate($res, 255, 0, 0);
$green = imagecolorallocate($res, 0, 255, 0);
imagefill($res, 0, 0, $red);
imagerectangle($res, 100, 100, 200, 200, $green);
imagejpeg($res);
```

**绘制填充好的实心矩形**

imageFilledRectangle (img_res,x1,y1,x2,y2,color)

- (x1,y1)为左上角坐标， (x2,y2)为右下角坐标

```
header('Content-type:image/jpeg');
$res = imagecreatetruecolor(1000, 500);
$red = imagecolorallocate($res, 255, 0, 0);
$green = imagecolorallocate($res, 0, 255, 0);
imagefill($res, 0, 0, $red);
imagefilledrectangle($res, 100, 100, 300, 300, $green);
imagejpeg($res);
```

### 绘制圆形

绘制空心圆形

- imageEllipse(img_res,x,y,w,h,color)

绘制填充好的实心圆

- imageFilledEllipse(img_res,x,y,w,h,color)

说明：

- (x,y)为圆心坐标。 w为宽度，h为高度

```
header('Content-type:image/jpeg');
$res = imagecreatetruecolor(500, 500);
$red = imagecolorallocate($res, 255, 0, 0);
$green = imagecolorallocate($res, 0, 255, 0);
imagefill($res, 0, 0, $red);
imageellipse($res, 250, 250, 100, 100, $green);
imagejpeg($res);
```

### 绘制线条

imageLine(img_res,x1,y1,x2,y2,color)

- (x1,y1)为起始点坐标
- (x2,y2)为结束点坐标

```
$res = imagecreatetruecolor(500, 500);
$red = imagecolorallocate($res, 255, 0, 0);
$green = imagecolorallocate($res, 0, 255, 0);
imagefill($res, 0, 0, $red);
imageline($res, 0, 0, 499, 499, $green);
imagepng($res);
```

### 绘制像素

bool imagesetpixel ( resource $image , int $x , int $y , int $color )

- (x1,y1)为点坐标

```
header('Content-type:image/jpeg');
$res = imagecreatetruecolor(500, 500);
$red = imagecolorallocate($res, 255, 0, 0);
$green = imagecolorallocate($res, 0, 255, 0);
imagefill($res, 0, 0, $red);
for ($i = 0; $i < 600; $i++) {
    imagesetpixel($res, mt_rand(0, 500), mt_rand(0, 500), $green);
}
imagepng($res);
```

### 输出图像

输出不同格式的图像用不同的方法：

- imagegif(img_resource[,filename])
- imagejpeg(img_resource[,filename])
- imagepng(img_resource[,filename])
- imagebmp(img_resource[,filename])
- 当设置第二个参数时表示储存文件，如果存在同名文件会覆盖

### 释放图像

imageDestroy(img_resource)

- 图像输出完毕及时释放资源，把内存空间留给更需要的程序。

### 输入文本

array imagettftext ( resource $image , float $size , float $angle , int $x , int $y , int $color , string $fontfile , string $text )

- 参数说明：图像资源，字体尺寸，角度，第一个字符的基本点（大概是字符的左下角），Y 坐标（字体基线的位置），颜色 ，字体文件，文本字符串（UTF-8 编码）

```
header('Content-type:image/png');
$res = imagecreatetruecolor(500, 500);
$red = imagecolorallocate($res, 255, 0, 0);
$green = imagecolorallocate($res, 0, 255, 0);
imagefill($res, 0, 0, $red);
$font = realpath('source.otf');
imagettftext($res, 50, 0, 0, 50, $green, $font, 'houdunren.com');
imagepng($res);
imagedestroy($res);
```

array imagettfbbox ( float $size , float $angle , string $fontfile , string $text )

- 文本范围的盒子大小，可以方便控制文本输出位置
- 返回一个含有 8 个单元的数组表示了文本外框的四个角：

| 变量 | 位置          |
| ---- | ------------- |
| 0    | 左下角 X 位置 |
| 1    | 左下角 Y 位置 |
| 2    | 右下角 X 位置 |
| 3    | 右下角 Y 位置 |
| 4    | 右上角 X 位置 |
| 5    | 右上角 Y 位置 |
| 6    | 左上角 X 位置 |
| 7    | 左上角 Y 位置 |

文字在画布右上角显示

```
$font = realpath('source.otf');
$text = 'houdunren.com';
$size = 16;
$box = imagettfbbox($size, 0, $font, 'houdunren.com');
$width  = $box[2] - $box[0];
$height = $box[0] - $box[7];
imagettftext($res, $size, 0, 500 - $width, $height, $green, $font, 'houdunren.com');
```

文字在画布中间显示

```
...
imagettftext($res, $size, 0, 250 - $width / 2, 250 - $height / 2, $green, $font, 'houdunren.com');
...
```

### 外部图像

打开图像

- - imageCreateFromgd(filename/url)
  - imageCreateFromgif(filename/url)
  - imageCreateFromjpeg(filename/url)
  - imageCreateFrompng(filename/url)
  - imageCreateFrombmp(filename/url)
  - 返回一个资源类型

### 获得信息

imagesx(img_resource)

- 取得图像宽度

imagesy(img_resource)

- 取得图像高度

getimagesize(img_file)

- array getimagesize ( string $filename [, array &$imageinfo ] )

### 图像复制

imagecopy 

- - 拷贝图像的一部分	
  - bool imagecopy ( resource $dst_im , resource $src_im , int $dst_x , int $dst_y , int $src_x , int $src_y , int $src_w , int $src_h )

imagecopymerge 

- - 拷贝并合并图像的一部分
  - bool imagecopymerge ( resource $dst_im , resource $src_im , int $dst_x , int $dst_y , int $src_x , int $src_y , int $src_w , int $src_h , int $pct )

### 图片缩放

imagecopyresized

- - 拷贝部分图像并调整大小
  - bool imagecopyresized ( resource $dst_image , resource $src_image , int $dst_x , int $dst_y , int $src_x , int $src_y , int $dst_w , int $dst_h , int $src_w , int $src_h )